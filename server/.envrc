#!/usr/bin/env bash
source_up

if ! has nix_direnv_version || ! nix_direnv_version 2.2.0; then
	source_url "https://raw.githubusercontent.com/nix-community/nix-direnv/2.2.0/direnvrc" "sha256-5EwyKnkJNQeXrRkYbwwRBcXbibosCJqyIUuz9Xq+LRc="
fi

NIX_CONFIG="extra-experimental-features = flakes nix-command"
export NIX_CONFIG

if [ -f "./flake.nix" ]; then
	FLAKE_PATH="."
else
	FLAKE_PATH="github:bruno-ebstein-pass-culture/pass-culture-app-native/nix?dir=server"
fi
use flake "${FLAKE_PATH}" # put in your environnement _almost_ everything needed when you use [Nix](https://nixos.org)

strict_env

layout node

if [ ! -d node_modules/ ]; then
	yarn install
fi

# needed to use `git-gamble`
TESTS_TO_RUN="$""(git list-modified-files)"
TESTS_TO_RUN="--onlyChanged"
TESTS_TO_RUN=" --changedSince origin/master"
# TESTS_TO_RUN=""
# TESTS_TO_RUN+="\"somefile\""

JEST_OPTIONS=""

export GAMBLE_TEST_COMMAND="yarn test:unit ${JEST_OPTIONS} ${TESTS_TO_RUN}"
